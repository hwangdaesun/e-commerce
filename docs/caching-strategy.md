# 인기 상품 조회 캐싱 전략

## 핵심 전략

인기 상품 조회시 Look Aside 전략 사용.

### 1. 캐시 스탬피드 방지 - RENAME 전략
**문제**: TTL 만료 시점에 동시 요청이 DB로 몰려 부하 발생

**해결**: 매 정각 스케줄러가 능동적으로 캐시 갱신
- 임시 키에 최신 데이터 저장 (TTL 25시간)
- Redis RENAME 명령으로 원자적 교체
- 데이터 공백 0초 보장 (기존 캐시 유지하며 교체)

**효과**:
- 동시 요청이 DB로 몰리는 현상 방지
- 항상 유효한 캐시 유지

### 2. 재고 기반 조건부 캐싱
**전략**: 재고 임계값(10개)을 기준으로 캐싱 여부 결정

- **재고 > 10**: 캐싱 O (성능 우선, TTL 1시간)
- **재고 ≤ 10**: 캐싱 X (정확도 우선, 매번 DB 조회)

**이유**:
- 품절 임박 상품은 실시간 정보가 중요
- 재고 충분한 상품은 성능 우선

### 3. 자동 캐시 무효화
**시점**: 재고 차감 후 재고가 임계값(10) 이하로 떨어질 때

**동작**:
- 재고 감소 트랜잭션에서 자동 캐시 삭제
- 품절 임박 상품은 이후 조회 시 캐싱 안 됨

**효과**:
- 낮은 재고 상품은 항상 최신 정보 제공

---

## 성능 개선 효과

| 조회 유형 | 캐싱 전      | 캐싱 후    | 개선율        |
|---------|-----------|---------|------------|
| 인기 상품 전체 목록 | 7~8s      | 30~50ms | **15~25배** |
| 인기 상품 상세 조회 | 300~400ms | 30~50ms | **6~15배**  |

---

## 캐시 설정

### Redis 캐시 이름
- **popular-items**: 인기 상품 전체 목록 (TTL 1일)
- **item**: 개별 상품 상세 (TTL 1시간)

### 캐시 관련 상수
- **TEMP_SUFFIX**: `:temp` (임시 키 접미사)
- **LOW_STOCK_THRESHOLD**: `10` (재고 임계값)

---

## 장점

1. **캐시 스탬피드 완벽 방지**: RENAME 전략으로 동시 요청 DB 부하 제거
2. **실시간 정확도 보장**: 재고 부족 상품은 항상 최신 정보
3. **성능 대폭 개선**: 5~20배 응답 속도 향상
4. **간단한 구현**: Spring Cache + 스케줄러로 쉽게 관리
5. **자동 관리**: 캐시 갱신과 무효화가 자동으로 동작

## 단점

1. **메모리 중복 사용**: limit별로 별도 캐시 생성 (약 70KB, 무시 가능)
2. **재고 정보 지연**: 충분한 재고 상품은 최대 1시간 지연 가능 (주문 시 검증하므로 문제 없음)
3. **스케줄러 의존**: 정각마다 DB 조회 발생

---

## 적합성

### ✅ 적합한 경우
- 조회 빈도가 변경 빈도보다 압도적으로 높음
- 재고가 충분한 상품이 대부분
- 1시간 정도 데이터 지연 허용 가능
- 읽기 성능이 중요

### ❌ 부적합한 경우
- 실시간 재고 정확도가 필수적
- 모든 상품 재고가 항상 낮음
- 동적 가격 변경이 빈번

---

## 대안: 실시간성이 필요한 경우

### Redis Sorted Set 방식

**전략**: Item ID만 Sorted Set에 캐싱하고 score를 주기적으로 업데이트

**구조**:
- Key: `popular-items:realtime`
- Member: `itemId` (상품 ID)
- Score: `인기도 점수` (조회수 + 판매량 * 가중치)

**동작 방식**:
1. **짧은 주기 스케줄러** (예: 1분마다) 실행
2. 최근 집계 데이터로 각 상품의 score 업데이트
3. 조회 시 `ZREVRANGE`로 상위 N개 상품 ID 조회
4. 상품 상세 정보는 별도 캐시 또는 DB에서 조회

**장점**:
- 준실시간 인기도 반영 (1분 주기)
- 메모리 효율적 (ID만 저장, 중복 없음)
- 다양한 limit 값 지원 (단일 Sorted Set에서 ZREVRANGE로 조회)
- score만 업데이트하므로 빠름

**단점**:
- 상품 상세 정보는 별도 조회 필요 (추가 DB/캐시 조회)
- 스케줄러 주기가 짧아 부하 증가
- 구현 복잡도 증가

**사용 시기**:
- 실시간 인기 순위가 중요한 경우
- 인기도가 빠르게 변동하는 이벤트 기간
- 다양한 limit 값 요청이 많은 경우
