# 인기 상품 조회 캐싱 전략

## 핵심 전략

### 1. 캐시 스탬피드 방지 - RENAME 전략
**문제**: TTL 만료 시점에 동시 요청이 DB로 몰려 부하 발생

**해결**: 매 정각 스케줄러가 능동적으로 캐시 갱신
- 임시 키에 최신 데이터 저장 (TTL 25시간)
- Redis RENAME 명령으로 원자적 교체
- 데이터 공백 0초 보장 (기존 캐시 유지하며 교체)

**효과**:
- 동시 요청이 DB로 몰리는 현상 방지
- 항상 유효한 캐시 유지

### 2. 재고 기반 조건부 캐싱
**전략**: 재고 임계값(10개)을 기준으로 캐싱 여부 결정

- **재고 > 10**: 캐싱 O (성능 우선, TTL 1시간)
- **재고 ≤ 10**: 캐싱 X (정확도 우선, 매번 DB 조회)

**이유**:
- 품절 임박 상품은 실시간 정보가 중요
- 재고 충분한 상품은 성능 우선

### 3. 자동 캐시 무효화
**시점**: 재고 차감 후 재고가 임계값(10) 이하로 떨어질 때

**동작**:
- 재고 감소 트랜잭션에서 자동 캐시 삭제
- 품절 임박 상품은 이후 조회 시 캐싱 안 됨

**효과**:
- 낮은 재고 상품은 항상 최신 정보 제공
- 과매도 위험 감소

---

## 성능 개선 효과

| 조회 유형 | 캐싱 전 | 캐싱 후 | 개선율 |
|---------|--------|--------|-------|
| 인기 상품 전체 목록 | 100~200ms | 5~10ms | **10~20배** |
| 인기 상품 상세 조회 | 20~30ms | 3~5ms | **5~7배** |

---

## 캐시 설정

### Redis 캐시 이름
- **popular-items**: 인기 상품 전체 목록 (TTL 1일)
- **item**: 개별 상품 상세 (TTL 1시간)

### 캐시 관련 상수
- **TEMP_SUFFIX**: `:temp` (임시 키 접미사)
- **LOW_STOCK_THRESHOLD**: `10` (재고 임계값)

---

## 장점

1. **캐시 스탬피드 완벽 방지**: RENAME 전략으로 동시 요청 DB 부하 제거
2. **실시간 정확도 보장**: 재고 부족 상품은 항상 최신 정보
3. **성능 대폭 개선**: 5~20배 응답 속도 향상
4. **간단한 구현**: Spring Cache + 스케줄러로 쉽게 관리
5. **자동 관리**: 캐시 갱신과 무효화가 자동으로 동작

## 단점

1. **메모리 중복 사용**: limit별로 별도 캐시 생성 (약 70KB, 무시 가능)
2. **재고 정보 지연**: 충분한 재고 상품은 최대 1시간 지연 가능 (주문 시 검증하므로 문제 없음)
3. **스케줄러 의존**: 정각마다 DB 조회 발생

---

## 적합성

### ✅ 적합한 경우
- 조회 빈도가 변경 빈도보다 압도적으로 높음
- 재고가 충분한 상품이 대부분
- 1시간 정도 데이터 지연 허용 가능
- 읽기 성능이 중요

### ❌ 부적합한 경우
- 실시간 재고 정확도가 필수적
- 모든 상품 재고가 항상 낮음
- 동적 가격 변경이 빈번